<html>
  <head>
    <meta charset="UTF-8" />
    <title>Arduino LED Control</title>
  </head>
  <body style="text-align: center;padding-top: 30px;">
    <h1>LED Brightness Percentage</h1>
    <input
      type="number"
      id="brightnessInputBox"
      name="brightness"
      min="0"
      max="100"
      value="0"
    />
    <p>
      Open the browser's developer tools to see console messages (CTRL+SHIFT+C)
    </p>
    <script>
      dataChannel = null;

      function setupDataChannel(d) {
        console.log(d);
      }

      function dataChannelOpen(d) {
        console.log("Data channel open", d);
        d.target.send(JSON.stringify({ a: "b" }));
      }

      function dataChannelMessage(m) {
        console.log(m);
        console.log(JSON.parse(m.data));
      }

      async function waitForICECandidates(conn) {
        // Waits until the connection has finished gathering ICE candidates
        await new Promise(function(resolve) {
          if (conn.iceGatheringState === "complete") {
            resolve();
          } else {
            function checkState() {
              if (conn.iceGatheringState === "complete") {
                conn.removeEventListener("icegatheringstatechange", checkState);
                resolve();
              }
            }
            conn.addEventListener("icegatheringstatechange", checkState);
          }
        });
      }
      // Here we set up the RTC. We put it in an async function, since we will be
      // waiting for results from the server (Promises).
      async function setupRTC() {
        console.log("Setting up a real-time connection to the server");

        conn = new RTCPeerConnection();
        dataChannel = conn.createDataChannel("telemetry");
        dataChannel.onopen = dataChannelOpen;
        dataChannel.onmessage = dataChannelMessage;

        offer = await conn.createOffer();
        await conn.setLocalDescription(offer);

        // the python side does not support asynchronous ICE setup, so we wait until all ICE candidates are
        // ready before trying to connect
        await waitForICECandidates(conn);

        // At this point, the local connection has all the information needed to send its offer,
        // so we POST the information to the server, which will respond with the corresponding remote
        // connection's description

        response = await fetch("/setupRTC", {
          method: "POST",
          cache: "no-cache",
          body: JSON.stringify(conn.localDescription) // body data type must match "Content-Type" header
        });
        await conn.setRemoteDescription(await response.json());
        console.log("finished setup");
      }

      // Run the setup code above asynchronously
      setupRTC();

      // Set up the brightness input box
      const brightnessInputBox = document.querySelector("#brightnessInputBox");
      brightnessInputBox.oninput = function() {
        let brightness = parseInt(brightnessInputBox.value);
        console.log("Setting brightness to", brightness);
        dataChannel.send(JSON.stringify({ brightness: brightness }));
      };
    </script>
  </body>
</html>
